<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receituário Inteligente - Neonatologia Alcon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animação do loader */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="container mx-auto max-w-5xl px-4 sm:px-6">
            <div class="flex items-center justify-between h-20">
                <h1 class="text-xl sm:text-2xl font-bold text-slate-800">✨ Receituário Inteligente</h1>
                <a href="index.html" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Voltar
                </a>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto max-w-5xl p-4 sm:p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <!-- Formulário de Entrada -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold text-slate-700 border-b pb-3 mb-4">Informações para Prescrição</h2>
            <form id="prescription-form" class="space-y-4">
                <div>
                    <label for="patient-name" class="block text-sm font-medium text-slate-600">Nome do Paciente (Opcional)</label>
                    <input type="text" id="patient-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: RN de Maria">
                </div>
                <div>
                    <label for="weight" class="block text-sm font-medium text-slate-600">Peso do Paciente (kg)</label>
                    <input type="number" step="0.01" id="weight" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: 3.2" required>
                </div>
                <div>
                    <label for="medication" class="block text-sm font-medium text-slate-600">Medicamento e Apresentação</label>
                    <input type="text" id="medication" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: Paracetamol 100mg/mL" required>
                </div>
                <div>
                    <label for="dosage" class="block text-sm font-medium text-slate-600">Dose Desejada</label>
                    <input type="text" id="dosage" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: 15mg/kg/dose ou 50mg/kg/dia" required>
                </div>
                <div>
                    <label for="frequency" class="block text-sm font-medium text-slate-600">Frequência</label>
                    <input type="text" id="frequency" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: 6/6h, se febre" required>
                </div>
                <button type="submit" id="generate-btn" class="w-full inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                    ✨ Gerar Receita com IA
                </button>
            </form>
        </div>

        <!-- Área de Resultado -->
        <div class="bg-slate-50 p-6 rounded-lg border border-dashed border-slate-300">
            <div id="result-container" class="prose max-w-none prose-slate">
                <p class="text-slate-500 text-center">A receita gerada pela IA aparecerá aqui.</p>
            </div>
            
            <!-- Loader -->
            <div id="loader" class="hidden items-center justify-center flex-col text-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                <h2 class="text-lg font-semibold text-slate-600">Calculando dose e gerando texto...</h2>
                <p class="w-full text-center text-slate-500">Isso pode levar alguns segundos.</p>
            </div>

            <!-- Botão de Copiar -->
            <button id="copy-btn" class="hidden mt-4 w-full inline-flex justify-center items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md shadow-sm text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Copiar Texto da Receita
            </button>
            <div id="copy-feedback" class="text-center text-sm text-green-600 mt-2 font-medium"></div>

        </div>
    </main>

    <script>
        const form = document.getElementById('prescription-form');
        const generateBtn = document.getElementById('generate-btn');
        const resultContainer = document.getElementById('result-container');
        const loader = document.getElementById('loader');
        const copyBtn = document.getElementById('copy-btn');
        const copyFeedback = document.getElementById('copy-feedback');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Coletar dados do formulário
            const patientName = document.getElementById('patient-name').value;
            const weight = document.getElementById('weight').value;
            const medication = document.getElementById('medication').value;
            const dosage = document.getElementById('dosage').value;
            const frequency = document.getElementById('frequency').value;

            // Validar se os campos obrigatórios foram preenchidos
            if (!weight || !medication || !dosage || !frequency) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Mostrar loader e esconder resultado anterior
            loader.style.display = 'flex';
            resultContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            copyBtn.style.display = 'none';
            copyFeedback.textContent = '';

            // Construir o prompt para a API Gemini
            const prompt = `
                Você é um assistente de neonatologia. Sua tarefa é gerar um texto de receita médica a partir dos dados fornecidos.
                Calcule a dose exata em mL ou gotas para o paciente.
                Formate a saída como um JSON com a seguinte estrutura: {"titulo": "string", "nomePaciente": "string", "corpoReceita": "string", "orientacoes": "string", "alertaMedico": "string"}.

                Dados:
                - Nome do Paciente: ${patientName || 'Não informado'}
                - Peso: ${weight} kg
                - Medicamento e Apresentação: ${medication}
                - Dose Desejada: ${dosage}
                - Frequência: ${frequency}

                Exemplo de como o texto da receita deve ser:
                "Uso Oral
                1. ${medication}
                   Dar X.X mL (ou X gotas), por via oral, de ${frequency}."

                As orientações devem ser claras para os pais. O alerta médico é uma nota para o profissional de saúde.
            `;

            try {
                // Chamada para a API Gemini
                const resultText = await callGemini(prompt);
                const resultJson = JSON.parse(resultText);

                // Renderizar o resultado
                renderResult(resultJson);

            } catch (error) {
                console.error('Erro ao chamar a API Gemini:', error);
                resultContainer.innerHTML = `<p class="text-red-500 text-center">Ocorreu um erro ao gerar a receita. Por favor, tente novamente. Detalhes: ${error.message}</p>`;
            } finally {
                // Esconder loader e mostrar resultado
                loader.style.display = 'none';
                resultContainer.style.display = 'block';
                if (resultContainer.textContent.length > 1) {
                    copyBtn.style.display = 'inline-flex';
                }
            }
        });

        // Função para chamar a API Gemini com retry e exponential backoff
        async function callGemini(prompt, retries = 3, delay = 1000) {
            const apiKey = ""; // A chave da API será injetada pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        // O resultado JSON está em formato de string, então precisa ser pego diretamente
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Resposta da API inválida ou vazia.');
                    }
                } catch (error) {
                    console.warn(`Tentativa ${i + 1} falhou. Tentando novamente em ${delay / 1000}s...`);
                    if (i === retries - 1) throw error; // Lança o erro na última tentativa
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        function renderResult(data) {
            resultContainer.innerHTML = `
                ${data.nomePaciente && data.nomePaciente !== 'Não informado' ? `<h3 class="font-bold text-lg">${data.nomePaciente}</h3>` : ''}
                <h4 class="font-semibold mt-4">${data.titulo || 'Prescrição Médica'}</h4>
                <pre class="bg-slate-100 p-3 rounded-md mt-2 whitespace-pre-wrap font-sans">${data.corpoReceita || ''}</pre>
                <h4 class="font-semibold mt-4">Orientações para os Pais</h4>
                <p>${data.orientacoes || ''}</p>
                <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700">
                    <h5 class="font-bold">Nota para o Médico</h5>
                    <p>${data.alertaMedico || ''}</p>
                </div>
            `;
        }

        // Funcionalidade de copiar
        copyBtn.addEventListener('click', () => {
            const textToCopy = `Paciente: ${document.getElementById('patient-name').value || 'Não informado'}\n\n${resultContainer.innerText}`;
            
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyFeedback.textContent = 'Copiado para a área de transferência!';
                setTimeout(() => copyFeedback.textContent = '', 2000);
            } catch (err) {
                console.error('Erro ao copiar texto: ', err);
                copyFeedback.textContent = 'Erro ao copiar.';
            }
            document.body.removeChild(textArea);
        });

    </script>
</body>
</html>
